
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Courses - PMERIT Platform</title>
  <meta name="description" content="Explore PMERIT courses designed for accessible, high-quality education worldwide.">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Theme Init - Prevent FOUC -->
  <script>
  (function() {
    var theme = localStorage.getItem('theme');
    if (!theme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      theme = 'dark';
    }
    if (theme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  })();
  </script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <!-- PMERIT Unified Design System -->
  <!-- PMERIT Standard CSS Imports -->
  <link rel="stylesheet" href="assets/css/theme-variables.css">
  <link rel="stylesheet" href="assets/css/typography.css">
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/responsive.css">
  <link rel="stylesheet" href="assets/css/components.css">
  
  
  <!-- Courses-specific styles -->
  <style>
    .courses-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-6);
    }
    
    .courses-header {
      text-align: center;
      margin-bottom: var(--space-8);
    }
    
    .courses-title {
      font-size: var(--text-4xl);
      font-weight: var(--font-bold);
      color: var(--text-primary);
      margin-bottom: var(--space-4);
    }
    
    .courses-subtitle {
      font-size: var(--text-xl);
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto;
    }
    
    .filters-section {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-8);
      box-shadow: var(--shadow);
    }
    
    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .search-box {
      position: relative;
      flex: 1;
      max-width: 400px;
    }
    
    .search-input {
      width: 100%;
      padding: var(--space-3) var(--space-4) var(--space-3) var(--space-12);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-full);
      font-size: var(--text-base);
      background-color: var(--card-bg);
      transition: var(--transition);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: var(--space-4);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }
    
    .view-toggle {
      display: flex;
      background-color: var(--bg-secondary);
      border-radius: var(--border-radius);
      padding: var(--space-1);
    }
    
    .view-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: var(--transition);
      font-size: var(--text-sm);
    }
    
    .view-btn.active {
      background-color: var(--primary);
      color: white;
    }
    
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .filter-label {
      font-weight: var(--font-medium);
      color: var(--text-primary);
      font-size: var(--text-sm);
    }
    
    .filter-select {
      padding: var(--space-3);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-primary);
      font-size: var(--text-sm);
    }
    
    .courses-section {
      margin-bottom: var(--space-8);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
    }
    
    .section-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }
    
    .course-count {
      color: var(--text-secondary);
      font-size: var(--text-sm);
    }
    
    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--space-6);
    }
    
    .course-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      transition: var(--transition);
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    
    .course-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }
    
    .course-thumbnail {
      height: 180px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: var(--text-4xl);
      position: relative;
    }
    
    .course-level {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background-color: rgba(255, 255, 255, 0.9);
      color: var(--text-primary);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--border-radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    
    .course-content {
      padding: var(--space-6);
    }
    
    .course-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin-bottom: var(--space-2);
      line-height: var(--leading-tight);
    }
    
    .course-instructor {
      color: var(--text-secondary);
      font-size: var(--text-sm);
      margin-bottom: var(--space-3);
    }
    
    .course-description {
      color: var(--text-secondary);
      font-size: var(--text-sm);
      line-height: var(--leading-relaxed);
      margin-bottom: var(--space-4);
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .course-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }
    
    .course-duration {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .course-rating {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .stars {
      color: #F59E0B;
    }
    
    .course-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }
    
    .course-tag {
      background-color: var(--bg-secondary);
      color: var(--text-secondary);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--border-radius);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    
    .course-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .course-price {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--primary);
    }
    
    .course-price.free {
      color: var(--success);
    }
    
    .course-action {
      padding: var(--space-2) var(--space-4);
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .course-action:hover {
      background-color: var(--primary-dark);
    }
    
    .course-action.enrolled {
      background-color: var(--success);
    }
    
    .empty-state {
      text-align: center;
      padding: var(--space-16);
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: var(--text-4xl);
      margin-bottom: var(--space-4);
      opacity: 0.5;
    }
    
    .list-view .courses-grid {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .list-view .course-card {
      display: flex;
      height: 200px;
    }
    
    .list-view .course-thumbnail {
      width: 300px;
      height: 100%;
      flex-shrink: 0;
    }
    
    .list-view .course-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    /* Mobile Styles */
    @media (max-width: 768px) {
      .courses-container {
        padding: var(--space-4);
      }
      
      .filters-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        max-width: none;
      }
      
      .filters-grid {
        grid-template-columns: 1fr;
      }
      
      .tracks-grid {
        grid-template-columns: 1fr;
      }
      
      .courses-grid {
        grid-template-columns: 1fr;
      }
      
      .list-view .course-card {
        flex-direction: column;
        height: auto;
      }
      
      .list-view .course-thumbnail {
        width: 100%;
        height: 180px;
      }
    }
  </style>
</head>
<body class="page-layout" data-layout-auto-init>
  <!-- Header -->
  <div class="page-header" id="header-container">
    <!-- Loaded dynamically via JavaScript -->
  </div>
  
  <!-- Main Content -->
  <main class="page-main" role="main">
    <div class="container courses-container">
      <!-- Page Header -->
      <div class="courses-header">
        <h1 class="courses-title">Explore Courses</h1>
        <p class="courses-subtitle">Discover high-quality courses designed to advance your career and unlock new opportunities</p>
      </div>
      
      <!-- Search and Filters -->
      <div class="filters-section">
        <div class="filters-header">
          <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search courses..." id="searchInput">
          </div>
          
          <div class="view-toggle">
            <button class="view-btn active" id="gridViewBtn">
              <i class="fas fa-th"></i>
              Grid
            </button>
            <button class="view-btn" id="listViewBtn">
              <i class="fas fa-list"></i>
              List
            </button>
          </div>
        </div>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">Learning Pathway</label>
            <select class="filter-select" id="pathwayFilter">
              <option value="">All Pathways</option>
              <!-- Options populated dynamically from API -->
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">Category</label>
            <select class="filter-select" id="categoryFilter">
              <option value="">All Categories</option>
              <option value="programming">Programming</option>
              <option value="data-science">Data Science</option>
              <option value="design">Design</option>
              <option value="marketing">Digital Marketing</option>
              <option value="business">Business</option>
              <option value="languages">Languages</option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">Level</label>
            <select class="filter-select" id="levelFilter">
              <option value="">All Levels</option>
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Duration</label>
            <select class="filter-select" id="durationFilter">
              <option value="">Any Duration</option>
              <option value="short">Under 5 hours</option>
              <option value="medium">5-20 hours</option>
              <option value="long">20+ hours</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Price</label>
            <select class="filter-select" id="priceFilter">
              <option value="">All Prices</option>
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Courses Section -->
      <div class="courses-section">
        <div class="section-header">
          <h2 class="section-title">All Courses</h2>
          <div class="course-count" id="courseCount">Loading...</div>
        </div>
        
        <div class="courses-grid" id="coursesGrid">
          <!-- Loading state -->
          <div class="loading-state" id="coursesLoading">
            <div style="text-align: center; padding: 4rem;">
              <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
              <p style="color: var(--text-secondary);">Loading courses...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer will be loaded by layout-loader.js -->
  <div id="footer-container"></div>
  
  <!-- Core Scripts -->
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/settings-manager.js"></script>
  <script src="assets/js/layout-loader.js"></script>
  
  <!-- Courses-specific JavaScript -->
  <script>
    // PMERIT Courses Module
    window.PMERIT = window.PMERIT || {};
    
    window.PMERIT.Courses = {
      allCourses: [],
      filteredCourses: [],
      pathways: [],
      currentView: 'grid',
      filters: {
        search: '',
        pathway: '',
        category: '',
        level: '',
        duration: '',
        price: ''
      },

      // Initialize courses page
      async init() {
        console.log('ðŸŽ“ PMERIT Courses - Initializing...');

        try {
          // Check for pathway filter in URL
          const urlParams = new URLSearchParams(window.location.search);
          const pathwayParam = urlParams.get('pathway');
          if (pathwayParam) {
            this.filters.pathway = pathwayParam;
          }

          // Load pathways first (for dropdown), then courses
          await this.loadPathways();
          await this.loadCourses();

          // Set up event listeners
          this.bindEvents();

          // Apply initial filters (including URL param)
          this.applyFilters();

          console.log('âœ… Courses page initialized successfully');
        } catch (error) {
          console.error('âŒ Courses initialization failed:', error);
          this.showError('Failed to load courses data');
        }
      },
      
      // API Base URL
      API_BASE: 'https://pmerit-api-worker.peoplemerit.workers.dev/api/v1',

      // Load pathways from database/API and populate dropdown
      async loadPathways() {
        try {
          const response = await fetch(`${this.API_BASE}/pathways`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          // Store pathways for reference
          this.pathways = (data.pathways || []).map(p => ({
            id: p.pathway_id,
            slug: p.pathway_slug || p.id,
            name: p.pathway_name || p.name,
            trackType: p.track_type
          }));

          // Populate the pathway dropdown
          this.populatePathwayDropdown();

        } catch (error) {
          console.error('Failed to load pathways:', error);
          // Continue without pathways - dropdown will remain empty
        }
      },

      // Populate pathway filter dropdown
      populatePathwayDropdown() {
        const dropdown = document.getElementById('pathwayFilter');
        if (!dropdown) return;

        // Group pathways by track type
        const trackTypes = {
          'global_remote': 'Global Remote',
          'local_education': 'Local Education',
          'local_career': 'Local Career'
        };

        // Clear existing options except the first
        dropdown.innerHTML = '<option value="">All Pathways</option>';

        // Add optgroups for each track type
        Object.keys(trackTypes).forEach(trackType => {
          const pathwaysInTrack = this.pathways.filter(p => p.trackType === trackType);
          if (pathwaysInTrack.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = trackTypes[trackType];
            pathwaysInTrack.forEach(p => {
              const option = document.createElement('option');
              option.value = p.slug;
              option.textContent = p.name;
              // Check if this pathway is selected from URL
              if (this.filters.pathway === p.slug) {
                option.selected = true;
              }
              optgroup.appendChild(option);
            });
            dropdown.appendChild(optgroup);
          }
        });
      },

      // Load courses from database/API
      async loadCourses() {
        try {
          const response = await fetch(`${this.API_BASE}/courses`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          // Map courses to expected format (API returns: course_id, slug, title, etc.)
          this.allCourses = (data.courses || []).map(c => ({
            id: c.slug || c.course_id,
            pathwayId: c.pathway_id,
            pathwaySlug: this.getPathwaySlugById(c.pathway_id),
            pathwayName: c.pathway_name,
            title: c.title,
            instructor: c.instructor_name || 'PMERIT',
            description: c.description || '',
            category: c.category || 'general',
            level: c.difficulty_level || 'Beginner',
            duration: c.estimated_hours ? `${c.estimated_hours} hours` : '10 hours',
            rating: c.rating_average || 4.5,
            reviews: c.rating_count || 0,
            price: c.is_free ? 0 : (c.price || 0),
            tags: c.tags || [],
            icon: this.getCategoryIcon(c.category)
          }));
          this.filteredCourses = [...this.allCourses];
          this.displayCourses();
          console.log(`âœ… Loaded ${this.allCourses.length} courses from API`);

        } catch (error) {
          console.error('Failed to load courses:', error);
          this.loadSampleCourses();
        }
      },
      
      // Helper to get pathway slug by ID
      getPathwaySlugById(pathwayId) {
        const pathway = this.pathways.find(p => p.id === pathwayId);
        return pathway ? pathway.slug : null;
      },

      // Display courses
      displayCourses() {
        const container = document.getElementById('coursesGrid');
        const loading = document.getElementById('coursesLoading');
        const countElement = document.getElementById('courseCount');
        
        if (loading) {
          loading.style.display = 'none';
        }
        
        if (countElement) {
          countElement.textContent = `${this.filteredCourses.length} courses`;
        }
        
        if (!container) return;
        
        if (this.filteredCourses.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-search empty-icon"></i>
              <h3>No courses found</h3>
              <p>Try adjusting your search criteria or browse our career tracks above</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = this.filteredCourses.map(course => {
          const isEnrolled = this.isUserEnrolled(course.id);
          const actionText = isEnrolled ? 'Continue' : (course.price === 0 ? 'Enroll Free' : 'Enroll');
          const actionClass = isEnrolled ? 'enrolled' : '';
          
          return `
            <div class="course-card" onclick="window.PMERIT.Courses.viewCourse('${course.id}')">
              <div class="course-thumbnail">
                <i class="${course.icon || 'fas fa-book'}"></i>
                <div class="course-level">${course.level}</div>
              </div>
              <div class="course-content">
                <div>
                  <h3 class="course-title">${course.title}</h3>
                  <div class="course-instructor">by ${course.instructor}</div>
                  <p class="course-description">${course.description}</p>
                  <div class="course-meta">
                    <div class="course-duration">
                      <i class="fas fa-clock"></i>
                      ${course.duration}
                    </div>
                    <div class="course-rating">
                      <span class="stars">${this.renderStars(course.rating)}</span>
                      <span>(${course.reviews})</span>
                    </div>
                  </div>
                  <div class="course-tags">
                    ${course.tags.map(tag => `<span class="course-tag">${tag}</span>`).join('')}
                  </div>
                </div>
                <div class="course-footer">
                  <div class="course-price ${course.price === 0 ? 'free' : ''}">
                    ${course.price === 0 ? 'Free' : `$${course.price}`}
                  </div>
                  <button class="course-action ${actionClass}" onclick="event.stopPropagation(); window.PMERIT.Courses.enrollCourse('${course.id}')">
                    ${actionText}
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      },
      
      // Apply filters to courses
      applyFilters() {
        this.filteredCourses = this.allCourses.filter(course => {
          // Pathway filter (most important - filters by learning pathway)
          if (this.filters.pathway && course.pathwaySlug !== this.filters.pathway) {
            return false;
          }

          // Search filter
          if (this.filters.search) {
            const searchTerm = this.filters.search.toLowerCase();
            const searchableText = `${course.title} ${course.description} ${course.instructor} ${course.tags.join(' ')}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) {
              return false;
            }
          }

          // Category filter
          if (this.filters.category && course.category !== this.filters.category) {
            return false;
          }

          // Level filter
          if (this.filters.level && course.level.toLowerCase() !== this.filters.level) {
            return false;
          }
          
          // Duration filter
          if (this.filters.duration) {
            const hours = this.parseDuration(course.duration);
            if (this.filters.duration === 'short' && hours >= 5) return false;
            if (this.filters.duration === 'medium' && (hours < 5 || hours > 20)) return false;
            if (this.filters.duration === 'long' && hours <= 20) return false;
          }
          
          // Price filter
          if (this.filters.price) {
            if (this.filters.price === 'free' && course.price > 0) return false;
            if (this.filters.price === 'paid' && course.price === 0) return false;
          }
          
          return true;
        });
        
        this.displayCourses();
      },
      
      loadSampleCourses() {
        this.allCourses = [
          {
            id: 'html-css-basics',
            title: 'HTML & CSS Fundamentals',
            instructor: 'Sarah Johnson',
            description: 'Learn the building blocks of web development with hands-on projects and real-world examples.',
            category: 'programming',
            level: 'Beginner',
            duration: '8 hours',
            rating: 4.8,
            reviews: 234,
            price: 0,
            tags: ['HTML', 'CSS', 'Web Development'],
            icon: 'fas fa-code'
          },
          {
            id: 'javascript-essentials',
            title: 'JavaScript Essentials',
            instructor: 'Mike Chen',
            description: 'Master JavaScript fundamentals and build interactive web applications from scratch.',
            category: 'programming',
            level: 'Beginner',
            duration: '12 hours',
            rating: 4.7,
            reviews: 189,
            price: 49,
            tags: ['JavaScript', 'Programming', 'Web Development'],
            icon: 'fab fa-js-square'
          },
          {
            id: 'python-data-analysis',
            title: 'Data Analysis with Python',
            instructor: 'Dr. Lisa Wang',
            description: 'Analyze data using Python, pandas, and visualization libraries to extract meaningful insights.',
            category: 'data-science',
            level: 'Intermediate',
            duration: '16 hours',
            rating: 4.9,
            reviews: 156,
            price: 79,
            tags: ['Python', 'Data Analysis', 'Pandas'],
            icon: 'fab fa-python'
          },
          {
            id: 'digital-marketing-strategy',
            title: 'Digital Marketing Strategy',
            instructor: 'Alex Rodriguez',
            description: 'Build comprehensive digital marketing campaigns that drive results and ROI.',
            category: 'marketing',
            level: 'Intermediate',
            duration: '10 hours',
            rating: 4.6,
            reviews: 98,
            price: 59,
            tags: ['Marketing', 'Strategy', 'SEO'],
            icon: 'fas fa-chart-bar'
          },
          {
            id: 'ui-design-figma',
            title: 'UI Design with Figma',
            instructor: 'Emma Thompson',
            description: 'Create stunning user interfaces using Figma\'s powerful design tools and workflows.',
            category: 'design',
            level: 'Beginner',
            duration: '6 hours',
            rating: 4.8,
            reviews: 145,
            price: 39,
            tags: ['Figma', 'UI Design', 'Prototyping'],
            icon: 'fas fa-paint-brush'
          },
          {
            id: 'react-advanced',
            title: 'Advanced React Development',
            instructor: 'John Smith',
            description: 'Build complex React applications with hooks, context, and modern patterns.',
            category: 'programming',
            level: 'Advanced',
            duration: '20 hours',
            rating: 4.9,
            reviews: 87,
            price: 99,
            tags: ['React', 'JavaScript', 'Frontend'],
            icon: 'fab fa-react'
          }
        ];
        
        this.filteredCourses = [...this.allCourses];
        this.displayCourses();
      },
      
      // Helper functions
      getCategoryIcon(category) {
        const icons = {
          'Data Science': 'fas fa-chart-line',
          'Marketing': 'fas fa-bullhorn',
          'Design': 'fas fa-paint-brush',
          'Web Development': 'fas fa-code',
          'Management': 'fas fa-tasks',
          'Business': 'fas fa-briefcase',
          'Healthcare': 'fas fa-heartbeat',
          'Trades': 'fas fa-tools',
          'Hospitality': 'fas fa-utensils',
          'Public Safety': 'fas fa-shield-alt',
          'Social Services': 'fas fa-hands-helping',
          'Government': 'fas fa-landmark',
          'Early Education': 'fas fa-child',
          'Primary Education': 'fas fa-book-reader',
          'Secondary Education': 'fas fa-graduation-cap'
        };
        return icons[category] || 'fas fa-book';
      },

      renderStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        let stars = '';
        
        for (let i = 0; i < fullStars; i++) {
          stars += 'â˜…';
        }
        
        if (hasHalfStar) {
          stars += 'â˜†';
        }
        
        return stars || 'â˜…â˜…â˜…â˜…â˜…';
      },
      
      parseDuration(duration) {
        const match = duration.match(/(\d+)/);
        return match ? parseInt(match[1]) : 0;
      },
      
      isUserEnrolled(courseId) {
        // Check if user is enrolled in this course
        // This would check against the user's enrolled courses from the database
        return false; // Default to not enrolled for demo
      },
      
      // Event handlers
      viewCourse(courseId) {
        window.location.href = `course.html?slug=${courseId}`;
      },
      
      async enrollCourse(courseId) {
        try {
          // Check if user is authenticated using AUTH module
          const user = window.AUTH?.getCurrentUser();
          // Handle both 'id' (mock/local) and 'userId' (API response) property names
          const userId = user?.id || user?.userId;

          if (!user || !userId) {
            // Not logged in - redirect to sign up
            window.location.href = '/index.html#sign-up';
            return;
          }

          const response = await fetch(`${this.API_BASE}/courses/${courseId}/enroll`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: userId })
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Enrollment failed');
          }

          // Redirect to classroom with course context
          window.location.href = `/portal/classroom.html?courseId=${courseId}`;

        } catch (error) {
          console.error('Failed to enroll in course:', error);
          alert('Failed to enroll in course. Please try again.');
        }
      },
      
      toggleView(view) {
        this.currentView = view;
        const container = document.getElementById('coursesGrid');
        
        // Update button states
        document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
        document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
        
        // Update container class
        container.parentElement.classList.toggle('list-view', view === 'list');
        
        // Re-render courses with new layout
        this.displayCourses();
      },
      
      showError(message) {
        console.error('Courses Error:', message);
        // Could show a toast notification here
      },
      
      // Bind event listeners
      bindEvents() {
        // Search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            this.filters.search = e.target.value;
            this.applyFilters();
          });
        }
        
        // Filter selects (including pathway filter)
        const filterElements = ['pathwayFilter', 'categoryFilter', 'levelFilter', 'durationFilter', 'priceFilter'];
        filterElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('change', (e) => {
              const filterKey = id.replace('Filter', '');
              this.filters[filterKey] = e.target.value;

              // Update URL when pathway filter changes (for shareability)
              if (filterKey === 'pathway') {
                const url = new URL(window.location);
                if (e.target.value) {
                  url.searchParams.set('pathway', e.target.value);
                } else {
                  url.searchParams.delete('pathway');
                }
                window.history.replaceState({}, '', url);
              }

              this.applyFilters();
            });
          }
        });
        
        // View toggle buttons
        document.getElementById('gridViewBtn')?.addEventListener('click', () => this.toggleView('grid'));
        document.getElementById('listViewBtn')?.addEventListener('click', () => this.toggleView('list'));
      }
    };
    
    // Initialize courses page when DOM loads
    document.addEventListener('DOMContentLoaded', () => {
      window.PMERIT.Courses.init();
    });
  </script>
</body>
</html>
