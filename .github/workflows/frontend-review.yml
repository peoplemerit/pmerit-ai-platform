name: "ğŸ¤– PMERIT Frontend Auto Review"

on:
  push:
    branches:
      - main
      - dev
      - feature/**
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - 'assets/**'
      - 'partials/**'
  
  pull_request:
    branches:
      - main
      - dev
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - 'assets/**'
      - 'partials/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  lint-and-validate:
    name: "ğŸ§© Code Quality Checks"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: "ğŸ“¦ Install Linters"
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard eslint
      
      - name: "ğŸ” Run HTML Lint"
        continue-on-error: true
        run: |
          echo "Running HTMLHint..."
          htmlhint "**/*.html" --config .htmlhintrc || true
      
      - name: "ğŸ¨ Run CSS Lint"
        continue-on-error: true
        run: |
          echo "Running Stylelint..."
          npx stylelint "**/*.css" --config .stylelintrc.json || true
      
      - name: "âš™ï¸ Run JavaScript Lint"
        continue-on-error: true
        run: |
          echo "Running ESLint..."
          npx eslint "**/*.js" --config .eslintrc.json || true
      
      - name: "ğŸ“Š Generate Lint Report"
        run: |
          echo "### ğŸ“‹ Lint Summary" > lint-report.md
          echo "" >> lint-report.md
          echo "âœ… HTML, CSS, and JavaScript linting completed." >> lint-report.md
          echo "" >> lint-report.md
          echo "See workflow logs for detailed results." >> lint-report.md
      
      - name: "ğŸ“¤ Upload Lint Report"
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.md

  copilot-review:
    name: "ğŸ¤– GitHub Copilot Review"
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ” Load Copilot Configuration"
        run: |
          echo "Loading .copilot/config.yml and .copilot/instructions.md"
          ls -la .copilot/
      
      - name: "ğŸ§  Trigger Copilot Review"
        run: |
          echo "ğŸ¤– Copilot Review Initiated"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Reviewing files based on:"
          echo "  â€¢ .copilot/config.yml"
          echo "  â€¢ .copilot/instructions.md"
          echo "  â€¢ .copilot/hints/"
          echo ""
          echo "Focus areas:"
          echo "  âœ“ Responsive design (mobile-first)"
          echo "  âœ“ Brand consistency (Pmerit theme)"
          echo "  âœ“ Accessibility (WCAG AA)"
          echo "  âœ“ Code quality and structure"
          echo "  âœ“ Safe-area-inset for iOS"
          echo "  âœ“ 44px minimum touch targets"
          echo ""
          echo "ğŸ“ Review comments will be posted inline in this PR."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: "ğŸ“ Post Review Summary Comment"
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const comment = `
            ## ğŸ¤– Copilot Auto-Review Completed
            
            Frontend files have been reviewed for:
            - âœ… **Responsive design** (mobile-first approach)
            - âœ… **Brand consistency** (Pmerit theme colors & fonts)
            - âœ… **Accessibility** (WCAG AA standards)
            - âœ… **Code quality** (semantic HTML, CSS variables, modular JS)
            - âœ… **Mobile optimization** (safe-area-inset, touch targets)
            
            ### ğŸ“š Reference Files
            - [.copilot/config.yml](.copilot/config.yml)
            - [INSTRUCTIONS_Copilot.md](INSTRUCTIONS_Copilot.md)
            - [Pmerit Theme](.copilot/Pmerit-theme_typography.html)
            - [Blueprint](.copilot/blueprint-index.html)
            
            ### ğŸ” Review Focus
            Based on the [.copilot/instructions.md](.copilot/instructions.md):
            - Fonts: Montserrat (headings), Inter (body)
            - Colors: Dark Blue (#2A5B8C), Teal (#4AA4B9), Coral (#FF6B6B)
            - Mobile: Non-scrollable viewport, hamburger menu
            - Desktop: Three-panel layout, persistent sidebar
            
            See inline comments for specific feedback. ğŸ‘‡
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  label-pr:
    name: "ğŸ·ï¸ Auto-Label Pull Request"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: copilot-review
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ·ï¸ Add Labels"
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          labels: |
            frontend
            copilot-reviewed
            needs-human-review

  mobile-check:
    name: "ğŸ“± Mobile-First Validation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ“± Check Mobile Requirements"
        run: |
          echo "Checking mobile-first requirements..."
          
          # Check for safe-area-inset usage
          if grep -r "safe-area-inset" --include="*.css" .; then
            echo "âœ… Safe-area-inset found"
          else
            echo "âš ï¸  WARNING: safe-area-inset not found in CSS files"
          fi
          
          # Check for dvh (dynamic viewport height)
          if grep -r "dvh" --include="*.css" .; then
            echo "âœ… Dynamic viewport height (dvh) found"
          else
            echo "âš ï¸  WARNING: dvh not found (iOS compatibility)"
          fi
          
          # Check for mobile-first media queries
          if grep -r "@media (min-width:" --include="*.css" .; then
            echo "âœ… Mobile-first media queries found"
          else
            echo "âš ï¸  WARNING: No mobile-first media queries detected"
          fi
          
          # Check for CSS variables usage
          if grep -r "var(--" --include="*.css" .; then
            echo "âœ… CSS variables in use"
          else
            echo "âš ï¸  WARNING: CSS variables not found"
          fi
          
          echo ""
          echo "Mobile-first validation complete!"

  accessibility-check:
    name: "â™¿ Accessibility Audit"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
      
      - name: "â™¿ Check Accessibility Requirements"
        run: |
          echo "Checking accessibility standards..."
          
          # Check for alt attributes
          if grep -r '<img' --include="*.html" . | grep -v 'alt='; then
            echo "âš ï¸  WARNING: Images without alt attributes found"
          else
            echo "âœ… All images have alt attributes"
          fi
          
          # Check for ARIA labels
          if grep -r "aria-label" --include="*.html" .; then
            echo "âœ… ARIA labels found"
          else
            echo "âš ï¸  WARNING: No ARIA labels detected"
          fi
          
          # Check for semantic HTML
          if grep -r "<header>\|<main>\|<footer>\|<nav>" --include="*.html" .; then
            echo "âœ… Semantic HTML elements found"
          else
            echo "âš ï¸  WARNING: No semantic HTML5 elements detected"
          fi
          
          echo ""
          echo "Accessibility audit complete!"
