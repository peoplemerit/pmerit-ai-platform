<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Reset your PMERIT password"/>
  <title>Forgot Password - PMERIT</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Theme Init - Prevent FOUC -->
  <script>
  (function() {
    var theme = localStorage.getItem('theme');
    if (!theme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      theme = 'dark';
    }
    if (theme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  })();
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="assets/css/light-theme.css?v=4">
  <link rel="stylesheet" href="assets/css/components.css?v=4">
  <link rel="stylesheet" href="assets/css/responsive-fixes.css?v=4">

  <!-- Debug Logger -->
  <script src="assets/js/utils/logger.js"></script>

  <style>
    .recovery-container {
      max-width: 480px;
      margin: 0 auto;
      padding: 2rem 1rem;
      min-height: calc(100vh - 200px);
      min-height: calc(100dvh - 200px);
    }

    .recovery-card {
      background: var(--card-bg, #fff);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color, #e0e0e0);
    }

    .recovery-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .recovery-header .icon {
      font-size: 3rem;
      color: var(--primary-color, #0066cc);
      margin-bottom: 1rem;
    }

    .recovery-header h1 {
      font-size: 1.5rem;
      color: var(--text-primary, #333);
      margin-bottom: 0.5rem;
    }

    .recovery-header p {
      color: var(--text-secondary, #666);
      font-size: 0.95rem;
    }

    .recovery-form {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary, #333);
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color, #ccc);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--input-bg, #fff);
      color: var(--text-primary, #333);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color, #0066cc);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .recovery-message {
      display: none;
      padding: 0.875rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .recovery-message.error {
      display: block;
      background: #fee;
      border: 1px solid #fcc;
      color: #c00;
    }

    .recovery-message.success {
      display: block;
      background: #efe;
      border: 1px solid #cfc;
      color: #060;
    }

    .btn-primary {
      background: var(--primary-color, #0066cc);
      color: white;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--primary-hover, #0052a3);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .back-link {
      text-align: center;
      margin-top: 1.5rem;
    }

    .back-link a {
      color: var(--primary-color, #0066cc);
      text-decoration: none;
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    /* Step styles */
    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .code-input-group {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin: 1rem 0;
    }

    .code-input {
      width: 50px !important;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      padding: 0.5rem !important;
    }

    .password-requirements {
      font-size: 0.85rem;
      color: var(--text-secondary, #666);
      margin-top: 0.5rem;
    }

    .password-requirements ul {
      margin: 0.5rem 0 0 1.25rem;
      padding: 0;
    }

    .password-requirements li {
      margin-bottom: 0.25rem;
    }

    .resend-link {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .resend-link a {
      color: var(--primary-color, #0066cc);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Header Partial (loaded via JS) -->
  <header id="header-container"></header>

  <main>
    <div class="recovery-container">
      <div class="recovery-card">
        <!-- Step 1: Enter Email -->
        <div id="step-email" class="step active">
          <div class="recovery-header">
            <div class="icon"><i class="fas fa-key"></i></div>
            <h1>Forgot Password?</h1>
            <p>Enter your email address and we'll send you a code to reset your password.</p>
          </div>

          <div id="email-message" class="recovery-message"></div>

          <form id="email-form" class="recovery-form">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" required autocomplete="email" placeholder="your@email.com">
            </div>

            <button type="submit" class="btn-primary" id="send-code-btn">
              Send Reset Code
            </button>
          </form>

          <div class="back-link">
            <a href="/?auth=signin"><i class="fas fa-arrow-left"></i> Back to Sign In</a>
          </div>
        </div>

        <!-- Step 2: Enter Code -->
        <div id="step-code" class="step">
          <div class="recovery-header">
            <div class="icon"><i class="fas fa-envelope-open-text"></i></div>
            <h1>Check Your Email</h1>
            <p>We sent a 6-digit code to <strong id="sent-email"></strong></p>
          </div>

          <div id="code-message" class="recovery-message"></div>

          <form id="code-form" class="recovery-form">
            <div class="form-group">
              <label>Enter 6-digit Code</label>
              <div class="code-input-group">
                <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric" pattern="[0-9]">
              </div>
            </div>

            <button type="submit" class="btn-primary" id="verify-code-btn">
              Verify Code
            </button>
          </form>

          <div class="resend-link">
            Didn't receive a code? <a id="resend-code" href="#">Resend</a>
          </div>

          <div class="back-link">
            <a href="#" id="back-to-email"><i class="fas fa-arrow-left"></i> Use a different email</a>
          </div>
        </div>

        <!-- Step 3: New Password -->
        <div id="step-password" class="step">
          <div class="recovery-header">
            <div class="icon"><i class="fas fa-lock"></i></div>
            <h1>Create New Password</h1>
            <p>Enter your new password below.</p>
          </div>

          <div id="password-message" class="recovery-message"></div>

          <form id="password-form" class="recovery-form">
            <div class="form-group">
              <label for="new-password">New Password</label>
              <input type="password" id="new-password" name="new-password" required autocomplete="new-password" placeholder="Enter new password">
              <div class="password-requirements">
                Password must contain:
                <ul>
                  <li>At least 8 characters</li>
                  <li>Uppercase and lowercase letters</li>
                  <li>At least one number</li>
                  <li>At least one special character (!@#$%^&*)</li>
                </ul>
              </div>
            </div>

            <div class="form-group">
              <label for="confirm-password">Confirm Password</label>
              <input type="password" id="confirm-password" name="confirm-password" required autocomplete="new-password" placeholder="Confirm new password">
            </div>

            <button type="submit" class="btn-primary" id="reset-password-btn">
              Reset Password
            </button>
          </form>
        </div>

        <!-- Step 4: Success -->
        <div id="step-success" class="step">
          <div class="recovery-header">
            <div class="icon" style="color: #28a745;"><i class="fas fa-check-circle"></i></div>
            <h1>Password Reset!</h1>
            <p>Your password has been successfully reset. You can now sign in with your new password.</p>
          </div>

          <a href="/?auth=signin" class="btn-primary" style="display: block; text-align: center; text-decoration: none;">
            Sign In
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer Partial (loaded via JS) -->
  <footer id="footer-container"></footer>

  <!-- Scripts -->
  <script src="assets/js/config.js"></script>
  <script>
    (function() {
      const API_BASE = window.CONFIG?.API_BASE_URL || 'https://pmerit-api-worker.peoplemerit.workers.dev';
      let userEmail = '';
      let resetCode = '';

      // DOM Elements
      const steps = {
        email: document.getElementById('step-email'),
        code: document.getElementById('step-code'),
        password: document.getElementById('step-password'),
        success: document.getElementById('step-success')
      };

      // Pre-fill email from session storage (from sign-in page)
      const savedEmail = sessionStorage.getItem('pmerit_forgot_password_email');
      if (savedEmail) {
        document.getElementById('email').value = savedEmail;
        sessionStorage.removeItem('pmerit_forgot_password_email');
      }

      // Step navigation
      function showStep(stepName) {
        Object.values(steps).forEach(step => step.classList.remove('active'));
        steps[stepName].classList.add('active');
      }

      function showMessage(stepName, type, message) {
        const msgEl = document.getElementById(`${stepName}-message`);
        if (msgEl) {
          msgEl.textContent = message;
          msgEl.className = `recovery-message ${type}`;
        }
      }

      function clearMessage(stepName) {
        const msgEl = document.getElementById(`${stepName}-message`);
        if (msgEl) {
          msgEl.textContent = '';
          msgEl.className = 'recovery-message';
        }
      }

      function setLoading(btnId, loading) {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.disabled = loading;
          if (loading) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Please wait...';
          } else {
            // Restore original text based on button
            const texts = {
              'send-code-btn': 'Send Reset Code',
              'verify-code-btn': 'Verify Code',
              'reset-password-btn': 'Reset Password'
            };
            btn.textContent = texts[btnId] || 'Submit';
          }
        }
      }

      // Step 1: Send reset code
      document.getElementById('email-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMessage('email');

        userEmail = document.getElementById('email').value.trim();
        if (!userEmail) {
          showMessage('email', 'error', 'Please enter your email address');
          return;
        }

        setLoading('send-code-btn', true);

        try {
          const response = await fetch(`${API_BASE}/api/v1/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
          });

          const data = await response.json();

          if (data.success) {
            document.getElementById('sent-email').textContent = userEmail;
            showStep('code');
            // Focus first code input
            document.querySelector('.code-input')?.focus();
          } else {
            showMessage('email', 'error', data.message || 'Failed to send reset code');
          }
        } catch (error) {
          console.error('Send code error:', error);
          showMessage('email', 'error', 'Network error. Please try again.');
        } finally {
          setLoading('send-code-btn', false);
        }
      });

      // Code input handling
      const codeInputs = document.querySelectorAll('.code-input');
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^0-9]/g, '');
          e.target.value = value;

          if (value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });

        // Handle paste
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
          pastedData.split('').forEach((digit, i) => {
            if (codeInputs[i]) {
              codeInputs[i].value = digit;
            }
          });
          if (pastedData.length === 6) {
            codeInputs[5].focus();
          }
        });
      });

      // Step 2: Verify code
      document.getElementById('code-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMessage('code');

        resetCode = Array.from(codeInputs).map(input => input.value).join('');
        if (resetCode.length !== 6) {
          showMessage('code', 'error', 'Please enter the 6-digit code');
          return;
        }

        // Move to password step (verification happens during password reset)
        showStep('password');
        document.getElementById('new-password')?.focus();
      });

      // Step 3: Reset password
      document.getElementById('password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMessage('password');

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (!newPassword || !confirmPassword) {
          showMessage('password', 'error', 'Please fill in both password fields');
          return;
        }

        if (newPassword !== confirmPassword) {
          showMessage('password', 'error', 'Passwords do not match');
          return;
        }

        // Validate password strength
        const hasMinLength = newPassword.length >= 8;
        const hasUppercase = /[A-Z]/.test(newPassword);
        const hasLowercase = /[a-z]/.test(newPassword);
        const hasNumber = /[0-9]/.test(newPassword);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(newPassword);

        if (!hasMinLength || !hasUppercase || !hasLowercase || !hasNumber || !hasSpecial) {
          showMessage('password', 'error', 'Password does not meet requirements');
          return;
        }

        setLoading('reset-password-btn', true);

        try {
          const response = await fetch(`${API_BASE}/api/v1/auth/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: userEmail,
              code: resetCode,
              newPassword: newPassword
            })
          });

          const data = await response.json();

          if (data.success) {
            showStep('success');
          } else {
            showMessage('password', 'error', data.message || data.error || 'Failed to reset password');
          }
        } catch (error) {
          console.error('Reset password error:', error);
          showMessage('password', 'error', 'Network error. Please try again.');
        } finally {
          setLoading('reset-password-btn', false);
        }
      });

      // Resend code
      document.getElementById('resend-code').addEventListener('click', async (e) => {
        e.preventDefault();
        clearMessage('code');

        try {
          const response = await fetch(`${API_BASE}/api/v1/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
          });

          const data = await response.json();

          if (data.success) {
            showMessage('code', 'success', 'A new code has been sent to your email');
            // Clear code inputs
            codeInputs.forEach(input => input.value = '');
            codeInputs[0]?.focus();
          } else {
            showMessage('code', 'error', data.message || 'Failed to resend code');
          }
        } catch (error) {
          console.error('Resend code error:', error);
          showMessage('code', 'error', 'Network error. Please try again.');
        }
      });

      // Back to email
      document.getElementById('back-to-email').addEventListener('click', (e) => {
        e.preventDefault();
        showStep('email');
        // Clear code inputs
        codeInputs.forEach(input => input.value = '');
      });

      // Load header and footer partials
      fetch('partials/header.html')
        .then(r => r.text())
        .then(html => document.getElementById('header-container').innerHTML = html);

      fetch('partials/footer.html')
        .then(r => r.text())
        .then(html => document.getElementById('footer-container').innerHTML = html);
    })();
  </script>
</body>
</html>
